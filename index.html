<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Rock: Multi-User Realtime</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --card-bg: rgba(25, 25, 30, 0.9); --accent: #e94560; --xp-color: #4ecc71; --gold: #ffd700; }
        body {
            font-family: 'Segoe UI', sans-serif; color: white; margin: 0; padding: 15px;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.85)), 
                        url('https://googleusercontent.com/image_generation_content/0?filename=image_0.png');
            background-size: cover; background-attachment: fixed;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 15px; }
        .card { background: var(--card-bg); border: 1px solid #444; border-radius: 12px; padding: 15px; backdrop-filter: blur(10px); }
        .guild-name { color: var(--gold); font-weight: bold; font-size: 1.2rem; display: block; margin-bottom: 10px; border-bottom: 1px solid #555; }
        .res-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-bottom: 10px; }
        .res-box { background: #1a1a1a; padding: 5px; border-radius: 4px; text-align: center; font-size: 0.8rem; }
        .infra { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.85rem; }
        button { width: 100%; padding: 10px; margin: 3px 0; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-xp { background: var(--xp-color); color: #000; }
        .btn-xp:disabled { background: #444; color: #888; }
        .btn-risk { background: var(--accent); color: white; }
    </style>
</head>
<body>

    <h1 style="text-align:center;">THE ROCK: PANEL REALTIME</h1>
    <div class="grid" id="game-grid">Cargando datos del reino...</div>

<script>
    import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
    const firebaseConfig = {
        const firebaseConfig = {
  apiKey: "AIzaSyA6g5rkoUXO5u6q829pm7r7Vg9v5MdEkUY",
  authDomain: "therockgamebuildingknowledge.firebaseapp.com",
  projectId: "therockgamebuildingknowledge",
  storageBucket: "therockgamebuildingknowledge.firebasestorage.app",
  messagingSenderId: "1078187057601",
  appId: "1:1078187057601:web:4c8241f6dbb77cea980f40",
  measurementId: "G-PCL1NP8CYN"
};

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

    const GUILDS = ["Woodmasters", "Blacksmiths", "Stonemasons", "Merchants", "Engineers", "Explorers"];

    // --- 2. ESCUCHAR CAMBIOS EN TIEMPO REAL ---
    db.ref('groups').on('value', (snapshot) => {
        const data = snapshot.val();
        if (!data) {
            // Si la base est√° vac√≠a, la inicializamos
            let initial = {};
            GUILDS.forEach((name, i) => {
                initial[i] = { id: i, name: name, role: null, xp: 0, debt: 0, vp: 0, hasVilla: false, hasPath: false };
            });
            db.ref('groups').set(initial);
        } else {
            render(data);
        }
    });

    function render(groups) {
        const container = document.getElementById('game-grid');
        container.innerHTML = '';
        Object.values(groups).forEach(g => {
            const isReady = g.hasVilla && g.hasPath;
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <span class="guild-name">${g.name}</span>
                ${!g.role ? `
                    <button onclick="updateGroup(${g.id}, {role:'hard', xp:0, debt:0})">DEBIT: Hard Worker (30 XP)</button>
                    <button class="btn-risk" onclick="updateGroup(${g.id}, {role:'risk', xp:0, debt:60})">CREDIT: Risk Taker (60 XP)</button>
                ` : `
                    <div class="res-grid">
                        <div class="res-box">‚ú® XP<br><b>${Math.floor(g.xp)}</b></div>
                        <div class="res-box" style="color:var(--gold)">üèÜ VP<br><b>${g.vp}</b></div>
                        <div class="res-box" style="color:var(--accent)">‚ö†Ô∏è DEUDA<br><b>${Math.floor(g.debt)}</b></div>
                    </div>
                    <div class="infra">
                        <strong>Infraestructura:</strong><br>
                        <label><input type="checkbox" ${g.hasVilla ? 'checked' : ''} onchange="toggleInfra(${g.id}, 'hasVilla', ${g.hasVilla})"> Villa</label> | 
                        <label><input type="checkbox" ${g.hasPath ? 'checked' : ''} onchange="toggleInfra(${g.id}, 'hasPath', ${g.hasPath})"> Camino</label>
                    </div>
                    <button class="btn-xp" ${!isReady ? 'disabled' : ''} onclick="addXP(${g.id}, 10, ${g.xp}, ${g.debt}, '${g.role}')">
                        ${isReady ? 'üî® PRODUCIR (+10 XP)' : 'Bloqueado (Falta Villa/Camino)'}
                    </button>
                    <button style="background:#444; color:white;" onclick="changeVP(${g.id}, ${g.vp}, ${g.debt}, '${g.role}')">Misi√≥n / Expedici√≥n</button>
                    <button style="background:#222; color:#777; font-size:0.6rem;" onclick="resetGroup(${g.id})">Reiniciar Grupo</button>
                `}
            `;
            container.appendChild(card);
        });
    }

    // --- 3. FUNCIONES DE ACTUALIZACI√ìN (ESTO SE SINCRONIZA AL INSTANTE) ---
    function updateGroup(id, obj) {
        db.ref('groups/' + id).update(obj);
    }

    function toggleInfra(id, key, currentVal) {
        let update = {}; update[key] = !currentVal;
        updateGroup(id, update);
    }

    function addXP(id, amount, currentXP, currentDebt, role) {
        if (role === 'risk' && currentDebt > 0) {
            let tax = amount * 0.5;
            updateGroup(id, {
                debt: Math.max(0, currentDebt - tax),
                xp: currentXP + (amount - tax)
            });
        } else {
            updateGroup(id, { xp: currentXP + amount });
        }
    }

    function changeVP(id, currentVP, debt, role) {
        if (role === 'risk' && debt > 0) {
            alert("√âxito en la misi√≥n, pero la deuda impide ganar VP.");
        } else {
            updateGroup(id, { vp: currentVP + 5 });
        }
    }

    function resetGroup(id) {
        if(confirm("¬øReiniciar este grupo?")) {
            updateGroup(id, { role: null, xp: 0, debt: 0, vp: 0, hasVilla: false, hasPath: false });
        }
    }
</script>
</body>
</html>

